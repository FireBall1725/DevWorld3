plugins {
    id 'dev.architectury.loom' version '1.13-SNAPSHOT' apply false
    id 'architectury-plugin' version '3.4-SNAPSHOT'
    id 'com.github.johnrengelman.shadow' version '8.1.1' apply false
    id 'me.modmuss50.mod-publish-plugin' version '0.7.4' apply false
}

// Stonecutter properties
def mcVersion = stonecutter.current.version.split('-')[0]
def platform = stonecutter.current.version.split('-')[1]

architectury {
    minecraft = mcVersion
}

// Version configuration
allprojects {
    group = 'ca.fireball1725.devworld'

    if (System.getenv("CI_VERSION")) {
        version = System.getenv("CI_VERSION")
    } else {
        version = project.hasProperty('mod_version') ? mod_version : '4.0.0'
    }
    version = "${version}+mc${mcVersion}"
}

subprojects {
    apply plugin: 'dev.architectury.loom'
    apply plugin: 'architectury-plugin'
    apply plugin: 'maven-publish'

    base {
        archivesName = "$rootProject.name-${project.name}"
    }

    repositories {
        maven { url = 'https://maven.parchmentmc.org' }
    }

    dependencies {
        minecraft "com.mojang:minecraft:${mcVersion}"

        //? if >=1.20.1
        mappings loom.officialMojangMappings()
        //?  else
        /*mappings loom.layered() {
            officialMojangMappings()
            parchment("org.parchmentmc.data:parchment-1.19.2:2022.11.27@zip")
        }*/
    }

    // Java version based on MC version
    def javaVersion = mcVersion.startsWith('1.19') || mcVersion.startsWith('1.20') ? 17 : 21

    java {
        withSourcesJar()
        sourceCompatibility = JavaVersion.toVersion(javaVersion)
        targetCompatibility = JavaVersion.toVersion(javaVersion)
    }

    tasks.withType(JavaCompile).configureEach {
        it.options.release = javaVersion
    }

    publishing {
        publications {
            mavenJava(MavenPublication) {
                artifactId = base.archivesName.get()
                from components.java
            }
        }

        repositories {
            // Add publishing repos here
        }
    }
}

// Only include modules relevant to the current version/platform
def activeModules = ['common']

if (platform == 'forge' && (mcVersion == '1.19.2' || mcVersion == '1.20.1')) {
    activeModules << 'forge'
} else if (platform == 'neoforge' && mcVersion == '1.21.1') {
    activeModules << 'neoforge'
} else if (platform == 'fabric' && mcVersion == '1.21.1') {
    activeModules << 'fabric'
}

// This tells Gradle which subprojects to actually build
gradle.projectsEvaluated {
    subprojects {
        if (!activeModules.contains(project.name)) {
            project.tasks.all { task -> task.enabled = false }
        }
    }
}

// Publishing configuration
apply plugin: 'me.modmuss50.mod-publish-plugin'

publishMods {
    file = project.file("${platform}/build/libs/DevWorld3-${platform}-${version}.jar")
    changelog = rootProject.file("CHANGELOG.md").exists() ? rootProject.file("CHANGELOG.md").text : "No changelog provided"
    type = project.hasProperty('curse_release_type') ? curse_release_type : BETA
    modLoaders.add(platform == 'fabric' ? 'fabric' : (platform == 'neoforge' ? 'neoforge' : 'forge'))

    dryRun = !System.getenv("PUBLISH_MODS")

    curseforge {
        accessToken = providers.environmentVariable("CURSEFORGE_TOKEN")
        projectId = project.hasProperty('curse_project_id') ? curse_project_id : ''
        minecraftVersions.add(mcVersion)

        requires {
            if (platform == 'fabric') {
                slug = "fabric-api"
            } else if (platform == 'neoforge') {
                slug = "architectury-api"
            }
        }
    }

    modrinth {
        accessToken = providers.environmentVariable("MODRINTH_TOKEN")
        projectId = "devworld"  // Set your Modrinth project ID
        minecraftVersions.add(mcVersion)

        requires {
            if (platform == 'fabric') {
                id = "P7dR8mSH"  // Fabric API
            }
        }
    }

    github {
        accessToken = providers.environmentVariable("GITHUB_TOKEN")
        repository = "FireBall1725/DevWorld3"
        commitish = providers.environmentVariable("GITHUB_SHA").orElse("main")
        tagName = version.toString()
    }
}
